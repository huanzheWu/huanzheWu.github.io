---
layout: post
title: 【C++】C++内联函数解析
category: 技术
tags: C＋＋｜对象模型
description: 对C++内联函数进行分析
---

在C语言中，我们使用宏定义函数这种借助编译器的优化技术来减少程序的执行时间，那么在C++中有没有相同的技术或者更好的实现方法呢？答案是有的，那就是内联函数。内联函数作为编译器优化手段的一种技术，在降低运行时间上非常有用。我们将从：


1. 什么是内联函数


1. 为什么要使用内联函数


1. 内联函数优缺点分析


1. 何时使用内联函数
　　

这四个方面对内联函数进行介绍。

##什么是内联函数
内联函数是C++的增强特性之一，用来降低程序的运行时间。当内联函数收到编译器的指示时，即可发生内联：编译器将使用函数的定义体来替代函数调用语句，这种替代行为发生在编译阶段而非程序运行阶段。

值得注意的是，内联函数仅仅是对编译器的内联建议，编译器是否觉得采取你的建议取决于函数是否符合内联的有利条件。如何函数体非常大，那么编译器将忽略函数的内联声明，而将内联函数作为普通函数处理。
##如何使函数内联
定义函数时，在函数的最前面以关键字“inline”声明函数，即可使函数称为内联声明函数。、

例如：
<pre><code>
Class A
{
 Public:
    inline int add(int a, int b)
    {
       return (a + b);
    };
}

Class A
{
 Public:
    int add(int a, int b);
};

inline int A::add(int a, int b)
{
   return (a + b);
}
</code></pre>
##为什么要使用内联函数
有时候我们会写一些功能专一的函数，这些函数的函数体不大，包含了很少的执行语句。例如在计算1~1000以内的素数时，我们经常会使用开方操作使运算范围缩小，这时我们会写一个函数：
<pre><code>
int root(int n)
{
　　return (int)sqrt((float)n);
}
</code></pre>

然后我们的求范围内素数的函数可以这样写。
<pre><code>
int prime(int n)
{
    int i;
    for (i = 2; i <= root(n); i++)
    {
        if (n%i == 0)
　　　　　　return 0;
        return 1;
    }
}    
</code></pre>
当然，把root函数放在循环中不是个不明智的选择，但想象一下，在某个程序上下文内必须频繁地调用某个类似root的函数，其调用函数的花销会有多大：当遇到普通函数的调用指令时，程序会保存当前函数的执行现场，将函数中的局部变量以及函数地址压入堆栈，然后再将即将调用的新函数加载到内存中，这要经历复制参数值、跳转到所调用函数的内存位置、执行函数代码、存储函数返回值等过程，当函数执行完后，再获取之前正在调用的函数的地址，回去继续执行那个函数，运行时间开销简直太多了。

C++内联函数提供了替代函数调用的方案，通过inline声明，编译器首先在函数调用处使用函数体本身语句替换了函数调用语句，然后编译替换后的代码。因此，通过内联函数，编译器不需要跳转到内存其他地址去执行函数调用，也不需要保留函数调用时的现场数据。
##inline函数的优缺点分析
通过下面这些优缺点总结你大概会更理解为什么要使用inline函数：

优点：



- 它通过避免函数调用所带来的开销来提高你程序的运行速度。


- 当函数调用发生时，它节省了变量弹栈、压栈的开销。


- 它避免了一个函数执行完返回原现场的开销。


- 通过将函数声明为内联，你可以把函数定义放在头文件内。

缺点：

- 因为代码的扩展，内联函数增大了可执行程序的体积。


- C++内联函数的展开是中编译阶段，这就意味着如果你的内联函数发生了改动，那么就需要重新编译代码。


- 当你把内联函数放在头文件中时，它将会使你的头文件信息变多，不过头文件的使用者不用在意这些。


- 有时候内联函数并不受到青睐，比如在嵌入式系统中，嵌入式系统的存储约束可能不允许体积很大的可执行程序。
##什么时候该使用内联函数
当程序设计需要时，每个函数都可以声明为inline。下面列举一些有用的建议：



- 当对程序执行性能有要求时，那么就使用内联函数吧。


- 当你想宏定义一个函数时，那就果断使用内联函数吧。


- 在类内部定义的函数会默认声明为inline函数，这有利于 类实现细节的隐藏。
 

关键点



1. 内联声明只是一种对编译器的建议，编译器是否采用内联措施由编译器自己来决定。甚至在汇编阶段或链接阶段，一些没有inline声明的函数编译器也会将它内联展开。


1. 编译器的内联看起来就像是代码的复制与粘贴，这与预处理宏是很不同的：宏是强制的内联展开，可能将会污染所有的命名空间与代码，将为程序的调试带来困难。


1. 所有中类中定义的函数都默认声明为inline函数，所有我们不用显示地去声明inline。


1. 虚函数不允许内联。


1. 虽然说模板函数放中头文件中，但它们不一定是内联的。（不是说定义在头文件中的函数都是内联函数）。

    